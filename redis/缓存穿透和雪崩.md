# Redis缓存穿透和雪崩

## 缓存穿透 （查不到）

### 概述

缓存穿透的概念很简单，用户想要查询一个数据，发现Redis内存数据库没有，也就是缓存没有命中，于是向持久层数据库查询。发现数据库也没有，于是本次查询失败。当用户很多的时候，缓存都没有命中（秒杀！），于是都去请求了持久层数据库。这回给数据库造成很大的压力，这时候就出现了缓存穿透。

> 解决方案

**布隆过滤器**

布隆过滤器是一种数据结构，对所有可能查询的参数以hash形式存储，在控制层先进行校验，不符合则丢弃，从而避免了对底层存储系统的查询压力。

## 缓存击穿 （访问量太大，缓存过期）

### 概述

这里需要注意缓存击穿和缓存穿透的区别，是指一个key非常热点，在不停的扛着大并发，大并发集中对这一个点进行访问，当这个kety在失效的瞬间，持续的大并发就穿破缓存，直接请求数据库，就像在一个屏障上凿开了一个洞。

当某个key在过期的瞬间，有大量的请求并发访问，这累数据一般是热点数据，由于缓存过期，会同时访问数据库来查询最新数据，并回写缓存，会导致数据库瞬间压力过大。

> 解决方案

**设置热点数据永不过期**

从缓存层面来看，没有设置过期时间，所以不会出现热点key过期后产生的问题。

**加互斥锁**

分布式锁：使用分布式锁，保证对于每个key同时只有一个线程去查询后端服务，其他线程没有获得分布式锁的权限，因此只需要等待即可。这种方式将高并发的压力转移到了分布式锁，因此对分布式锁的考验很大。

## 缓存雪崩

### 概述

指在某一个时间段，缓存计中过期失效，Redis宕机。

产生雪崩的原因之一，比如在写文本的时候，马上就要到双十一零点，很快就会迎来一波抢购，这波商品的时间比较计中的放入了缓存，假设缓存有效时间一个效市，那么到了凌晨一点钟的时候，该批商品的缓存就都过期了。而这批商品的访问查询量还很大，都落到了数据库上，对于数据库而言，就会产生周期性的压力波峰。于是所有的请求都会到达存储层，存储层调用量会暴增，造成存储层也会挂的情况。

其实集中过期倒不是非常致命，比较知名的是缓存服务器某个节点宕机或断网。因为自然形成的缓存雪崩，一定是在某个时间段计中创建了缓存，这个时候数据库也是可以顶住压力的。无非就是对数据库产生周期性的压力而已。而缓存服务节点宕机，对数据库服务器造成的压力是不可预知的，很有可能瞬间就把数据库压垮

### 解决方案

**Redis高可用**

这个思想是，既然redis有可能挂掉，就部署集群多增加几台服务器

**限流降级**

这个思想是，在缓存失效后，通过加锁或者队列来控制数据库读写缓存的线程数量。比如对某个key只允许一个线程查询数据和写缓存

**数据预热**

数据预热的含义是正式部署之前，可以先把可能的数据先访问一遍，这样可能大量访问的数据就会加载到缓存中。在即将发生大兵合法访问前手动触发加载缓存不同的key，设置不同的过期时间，让缓存失效的时间尽量均匀。