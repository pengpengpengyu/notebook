# Redis集群



## 主从模式

### 简介

主机用来写，从机用来读，主机所有的数据，都会被从机保存



> 命令

```bash
slaveof ip port # 指定主服务的IP 端口
info replication # 查看节点信息
```

> 配置文件

> replicaof IP PORT
>
> masterauth 密码



### 说明

- 主机断开连接，从机依旧连接着主机等待主机恢复，主机恢复后，仍然可以正常镀锡

- 默认所有单机redis都是主机
- 如果使用命令行配置主从，重启后主从配置将会失效
- slave启动成功后连接到master后会发送一个sync同步命令，master接收到命令后，启动后台的存盘进程，同时手机所有接收到的用于修改数据集命令，在后台进程执行完毕之后，master将传送整个数据文件到slave,并完成一次完全同步
- 全量复制：slave服务在接收到数据库文件数据后，将其存盘并加载到内存中
- 增量复制：Master继续将所有收集到的修改命令依次传给slave,完成同步
- 只要是重新连接Master,一次完全同步（全量复制）将被自动执行

- 如果主机断了连接，可以在从机执行`slaveof no one `将从机设置为主机



## 哨兵模式

### 概述

主从切换技术的方法是：当主服务器宕机后，需要手动把一台从服务器切换为主服务器，需要人为干预，费时费力，还会造成一段时间内服务不可用。这不是一种推荐的方式，更多时候，我们优先考虑哨兵模式。redis从2.8开始提供了Sentinel(哨兵)架构来解决这个问题。

哨兵模式是一种特殊的模式，首先Redis提供了哨兵的命令，哨兵是是一个独立的进程，作为一个进程，它独立运行。其原理是**哨兵通过发送命令，等待Redis服务器响应，从而监控运行的多个Redis服务实例**.

假设主服务器宕机，哨兵1先检测到这个结果，系统并不会马上进行failover过程，仅仅是哨兵1主观的认为服务器不可用，这个现象称为**主观下线**。当后面的哨兵也检测到主服务器不可用，并且数量达到一定值时，那么哨兵之间会进行一次投票，投票的结果决定哪个服务成为Master



### 配置

1. 配置哨兵配置文件sentinel.conf

```bash
# sentinel monitor 被监控的名称 host prot 1
sentinel monitor myredis 127.0.0.1 6379 1
# 后面的数值1代表主机挂了,slave投票看让谁接替成为主机，票数最多的就会成为主机
```

2. 启动哨兵

```bash
redis-sentinel sentinel.conf
```

### 说明

- 如果Master节点断开了，就会从从机中随机选一个主服务器（算法）

- 之前的Master宕机之后再启动，将被当作新选举的Master的从机

### 优点

- 基于主从复制模式，所有主从优点，它都有
- 主从可以切换，故障可以转移，系统的可用性更好，高可用
- 主从模式的升级，手动到自动，更加健壮

### 缺点

- Redis不好在线扩容，集群容量一旦达到上限，在线扩容就十分麻烦
- 实现哨兵模式的配置很麻烦，选择很多



